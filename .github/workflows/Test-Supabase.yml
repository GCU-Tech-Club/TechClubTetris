name: Supabase Function Tests

on:
  push:
    branches: [ main, Arie-Testing ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x

    - name: Cache Deno dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/deno
          ~/.deno
        key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
        restore-keys: |
          ${{ runner.os }}-deno-

    - name: Validate project structure
      id: validate
      run: |
        set -euo pipefail
        cd supabase
        
        # Check critical files exist
        for file in config.toml functions/deno.json; do
          test -f "$file" || { echo "âŒ Missing $file"; exit 1; }
        done
        
        # Validate main deno.json
        deno eval "JSON.parse(Deno.readTextFileSync('./functions/deno.json'))" >/dev/null || {
          echo "âŒ Invalid main deno.json"
          exit 1
        }
        
        # Validate all function directories
        for func in functions/*/; do
          func_name=$(basename "$func")
          [[ "$func_name" == "_shared" ]] && continue
          
          # Check required files
          test -f "${func}index.ts" -a -f "${func}deno.json" || {
            echo "âŒ $func_name missing required files"
            exit 1
          }
          
          # Validate deno.json if not empty
          if [ -s "${func}deno.json" ]; then
            deno eval "JSON.parse(Deno.readTextFileSync('./${func}deno.json'))" >/dev/null || {
              echo "âŒ Invalid deno.json in $func_name"
              exit 1
            }
          fi
        done
        
        # Validate _shared directory
        test -f "functions/_shared/deno.json" || { echo "âŒ Missing _shared/deno.json"; exit 1; }
        test -d "functions/_shared/functions" || { echo "âŒ Missing _shared/functions"; exit 1; }
        test -d "functions/_shared/types" || { echo "âŒ Missing _shared/types"; exit 1; }
        
        # Validate migrations exist
        test -d "migrations" || { echo "âŒ Missing migrations directory"; exit 1; }
        
        echo "âœ… Configuration validation passed"

  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x

    - name: Cache Deno dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/deno
          ~/.deno
        key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
        restore-keys: |
          ${{ runner.os }}-deno-

    - name: Check formatting
      id: format
      run: |
        set -euo pipefail
        cd supabase/functions
        
        if deno fmt --check .; then
          echo "âœ… Code is properly formatted"
        else
          echo "âŒ Code is not formatted. Run 'deno fmt' locally."
          exit 1
        fi

    - name: Lint code
      id: lint
      continue-on-error: true
      run: |
        cd supabase/functions
        
        # Run lint and show results without failing
        if deno lint .; then
          echo "âœ… No linting issues found"
        else
          echo "âš ï¸  Linting issues detected (non-blocking)"
          echo "Run 'deno lint' locally to see details"
        fi

  test:
    name: Build and Test
    needs: [validate]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: Cache Deno dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/deno
          ~/.deno
        key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
        restore-keys: |
          ${{ runner.os }}-deno-

    - name: Setup local Supabase
      run: |
        cd supabase
        supabase start
        
        echo "âœ… Supabase local instance started with migrations applied"

    - name: Compile functions
      id: build
      run: |
        set -euo pipefail
        cd supabase/functions
        
        # Compile each function
        for func in */; do
          func_name=$(basename "$func")
          [[ "$func_name" == "_shared" ]] && continue
          
          deno check --all "${func}index.ts" || {
            echo "âŒ Failed to compile $func_name"
            exit 1
          }
        done
        
        # Compile shared functions
        for shared_func in _shared/functions/*.ts; do
          if [ -f "$shared_func" ]; then
            deno check --all "$shared_func" || {
              echo "âŒ Failed to compile $(basename $shared_func)"
              exit 1
            }
          fi
        done
        
        echo "âœ… All functions compiled successfully"

    - name: Run unit tests
      id: test
      run: |
        set -euo pipefail
        cd supabase/functions
        
        # Run tests with coverage
        if deno test --allow-all --parallel --coverage=coverage/ 2>&1; then
          echo "âœ… All tests passed"
          
          # Generate coverage report
          deno coverage coverage/ --lcov --output=coverage/lcov.info
          
          # Get coverage percentage
          coverage=$(deno coverage coverage/ | grep -oP 'cover \K[0-9.]+' || echo "0")
          echo "ðŸ“Š Test coverage: ${coverage}%"
          
          # Optional: Fail if coverage below threshold (commented out by default)
          # threshold=80
          # if (( $(echo "$coverage < $threshold" | bc -l) )); then
          #   echo "âŒ Coverage ${coverage}% is below threshold ${threshold}%"
          #   exit 1
          # fi
        else
          echo "âŒ Tests failed"
          exit 1
        fi

    - name: Test deployment readiness
      id: deploy
      run: |
        set -euo pipefail
        
        cd supabase
        
        # Verify all functions can be bundled
        if supabase functions build 2>&1 | grep -q "Error"; then
          echo "âŒ Function bundling failed"
          exit 1
        else
          echo "âœ… Functions are deployment ready"
        fi

    - name: Generate deployment preview
      if: github.event_name == 'pull_request'
      run: |
        {
          echo "### ðŸ“¦ Deployment Preview"
          echo ""
          echo "**Functions ready to deploy:**"
          echo ""
        } >> $GITHUB_STEP_SUMMARY
        
        cd supabase/functions
        for func in */; do
          func_name=$(basename "$func")
          [[ "$func_name" == "_shared" ]] && continue
          echo "- \`$func_name\`" >> $GITHUB_STEP_SUMMARY
        done
        
        {
          echo ""
          echo "**Environment:** Preview (requires Supabase credentials for deployment)"
        } >> $GITHUB_STEP_SUMMARY

  summary:
    name: Test Summary
    needs: [validate, lint, test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Create test summary
      run: |
        {
          echo "## ðŸ§ª Supabase Function Testing Summary"
          echo ""
          echo "| Test | Status |"
          echo "|------|--------|"
          echo "| Configuration | ${{ needs.validate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
          echo "| Formatting | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
          echo "| Linting | ${{ needs.lint.result == 'success' && 'âœ… Clean' || 'âš ï¸  Warnings' }} |"
          echo "| Compilation | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
          echo "| Unit Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
          echo "| Deployment Ready | ${{ needs.test.result == 'success' && 'âœ… Yes' || 'âŒ No' }} |"
          echo ""
          
          if [[ "${{ needs.validate.result }}" == "success" && "${{ needs.lint.result }}" == "success" && "${{ needs.test.result }}" == "success" ]]; then
            echo "**Status:** âœ… All checks passed - Ready for deployment"
          else
            echo "**Status:** âŒ Some checks failed - Review errors above"
          fi
          
          echo ""
          echo "---"
          echo ""
          echo "**Note:** Tests run against local Supabase instance with migrations automatically applied."
        } >> $GITHUB_STEP_SUMMARY